// CareShare Database Schema for Neon PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Auth models for NextAuth.js
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// User model with role-based access
enum UserRole {
  FAMILY_MEMBER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          UserRole  @default(FAMILY_MEMBER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts          Account[]
  sessions          Session[]
  familyMembers     FamilyMember[]
  sentInvitations   FamilyInvitation[]
  createdFamilies   Family[]           @relation("FamilyCreator")
  costs             Cost[]
  costSplits        CostSplit[]
  adminFamilies     AdminFamily[]
  assignedTasks     Task[]             @relation("AssignedTasks")
  taskAssignments   TaskAssignment[]
  orderedGifts      GiftOrder[]        @relation("OrderedGifts")
  orderedFood       FoodOrder[]        @relation("OrderedFood")
  messages          Message[]
  lifeStories       LifeStory[]
  medications       Medication[]
  notes             Note[]
  uploadedDocuments Document[]

  @@index([email])
}

// Family groups
model Family {
  id          String   @id @default(cuid())
  name        String
  description String?
  elderName   String?  // Name of the elderly person being cared for
  elderPhone  String?  // Contact phone number
  elderAddress String? // Physical address
  elderBirthday DateTime? // Birthday for reminders
  emergencyContact String? // Emergency contact info
  medicalNotes String?  // Medical notes/allergies
  notificationPreferences Json? // Notification and alert settings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String

  creator       User                 @relation("FamilyCreator", fields: [createdBy], references: [id])
  members       FamilyMember[]
  invitations   FamilyInvitation[]
  events        Event[]
  costs         Cost[]
  adminFamilies AdminFamily[]
  tasks         Task[]
  careActivities CareActivity[]
  resources     Resource[]
  giftOrders    GiftOrder[]
  foodOrders    FoodOrder[]
  messages      Message[]
  lifeStories   LifeStory[]
  medications   Medication[]
  notes         Note[]
  documents     Document[]
  carePlan      CarePlan?
  careScenarios CareScenario[]
  contributions FamilyContribution[]

  @@index([createdBy])
}

// Junction table for Family-User relationship
enum FamilyRole {
  CARE_MANAGER    // Primary family member responsible for care coordination
  FAMILY_MEMBER   // Regular family member
  CONTRIBUTOR     // Family member who contributes financially
  CARE_RECIPIENT  // The person receiving care
}

model FamilyMember {
  id        String     @id @default(cuid())
  familyId  String
  userId    String
  role      FamilyRole @default(FAMILY_MEMBER)
  joinedAt  DateTime   @default(now())

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([familyId, userId])
  @@index([familyId])
  @@index([userId])
  @@index([role])
}

// Family invitations for pending members
enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

model FamilyInvitation {
  id        String           @id @default(cuid())
  familyId  String
  email     String
  role      FamilyRole       @default(FAMILY_MEMBER)
  invitedBy String
  status    InvitationStatus @default(PENDING)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  family  Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  inviter User   @relation(fields: [invitedBy], references: [id], onDelete: Cascade)

  @@unique([familyId, email])
  @@index([familyId])
  @@index([email])
  @@index([status])
}

// Events (birthdays, appointments, food deliveries)
enum EventType {
  BIRTHDAY
  APPOINTMENT
  FOOD_DELIVERY
  VISIT
  OTHER
}

model Event {
  id          String    @id @default(cuid())
  familyId    String
  title       String
  description String?
  type        EventType
  eventDate   DateTime
  location    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([eventDate])
}

// Shared costs and contributions
enum CostStatus {
  PENDING
  PAID
  OVERDUE
}

model Cost {
  id          String     @id @default(cuid())
  familyId    String
  description String
  amount      Float
  status      CostStatus @default(PENDING)
  dueDate     DateTime?
  paidDate    DateTime?
  assignedTo  String?    // User assigned to pay this cost (deprecated - use splits)
  splitType   String     @default("EQUAL") // EQUAL, CUSTOM, SINGLE
  receiptUrl  String?    // URL/path to receipt/bill file
  fileName    String?    // Original file name
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  family       Family     @relation(fields: [familyId], references: [id], onDelete: Cascade)
  assignedUser User?      @relation(fields: [assignedTo], references: [id])
  splits       CostSplit[]

  @@index([familyId])
  @@index([status])
  @@index([assignedTo])
}

// Individual cost splits for each family member
model CostSplit {
  id        String     @id @default(cuid())
  costId    String
  userId    String
  amount    Float
  status    CostStatus @default(PENDING)
  paidDate  DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  cost Cost @relation(fields: [costId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([costId])
  @@index([userId])
  @@index([status])
}

// Admin-Family relationship (for care providers managing multiple families)
model AdminFamily {
  id       String   @id @default(cuid())
  adminId  String
  familyId String
  addedAt  DateTime @default(now())

  admin  User   @relation(fields: [adminId], references: [id], onDelete: Cascade)
  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([adminId, familyId])
  @@index([adminId])
  @@index([familyId])
}

// Tasks and to-dos
enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Task {
  id          String       @id @default(cuid())
  familyId    String
  title       String
  description String?
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus   @default(TODO)
  assignedTo  String?      // Deprecated - kept for backward compatibility
  dueDate     DateTime?
  completedAt DateTime?
  attachmentUrl String?    // URL/path to attached file
  fileName    String?      // Original file name
  fileType    String?      // MIME type (image/jpeg, application/pdf, etc.)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  family       Family           @relation(fields: [familyId], references: [id], onDelete: Cascade)
  assignedUser User?            @relation("AssignedTasks", fields: [assignedTo], references: [id])
  assignments  TaskAssignment[] // New: Multiple assignees

  @@index([familyId])
  @@index([assignedTo])
  @@index([status])
}

// Task assignments - Many-to-many relationship between Tasks and Users
model TaskAssignment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
}

// Care Plan activities
model CareActivity {
  id          String   @id @default(cuid())
  familyId    String
  title       String
  description String?
  category    String   // medication, exercise, nutrition, social, medical
  frequency   String?  // daily, weekly, monthly
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([category])
}

// Resources and documents
model Resource {
  id          String   @id @default(cuid())
  familyId    String
  title       String
  description String?
  category    String   // document, link, contact, service
  url         String?
  fileUrl     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([category])
}

// Gift marketplace orders
model GiftOrder {
  id          String   @id @default(cuid())
  familyId    String
  itemName    String
  description String?
  price       Float
  status      String   @default("pending") // pending, ordered, delivered
  orderedBy   String?
  orderDate   DateTime?
  deliveryDate DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  family      Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  orderedByUser User? @relation("OrderedGifts", fields: [orderedBy], references: [id])

  @@index([familyId])
  @@index([status])
}

// Food delivery orders
model FoodOrder {
  id           String   @id @default(cuid())
  familyId     String
  restaurant   String
  items        String   // JSON string of items
  totalAmount  Float
  status       String   @default("scheduled") // scheduled, ordered, delivered
  scheduledFor DateTime
  orderedBy    String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  family        Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  orderedByUser User?  @relation("OrderedFood", fields: [orderedBy], references: [id])

  @@index([familyId])
  @@index([status])
  @@index([scheduledFor])
}

// Family messages/communication
model Message {
  id        String   @id @default(cuid())
  familyId  String
  userId    String
  message   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([userId])
  @@index([createdAt])
}

// Life stories and memories
enum StoryCategory {
  CHILDHOOD
  FAMILY
  CAREER
  LIFE_WISDOM
  MILESTONE
  STORY
  JOURNAL
}

enum ContentType {
  TEXT
  PHOTO
  AUDIO
  VIDEO
  DOCUMENT
}

model LifeStory {
  id          String        @id @default(cuid())
  familyId    String
  userId      String
  title       String
  content     String        @db.Text
  category    StoryCategory
  contentType ContentType   @default(TEXT)
  year        Int?
  tags        String?       // Comma-separated tags
  visibility  String        @default("family") // family, private, public
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([userId])
  @@index([category])
  @@index([createdAt])
}

// Medication management
enum MedicationFrequency {
  ONCE_DAILY
  TWICE_DAILY
  THREE_TIMES_DAILY
  FOUR_TIMES_DAILY
  AS_NEEDED
  WEEKLY
  MONTHLY
  OTHER
}

model Medication {
  id           String               @id @default(cuid())
  familyId     String
  userId       String               // Person who added the medication
  name         String
  dosage       String
  frequency    MedicationFrequency
  timeOfDay    String?              // e.g., "8:00 AM, 8:00 PM"
  instructions String?              @db.Text
  prescribedBy String?              // Doctor name
  startDate    DateTime
  endDate      DateTime?
  refillDate   DateTime?
  pharmacy     String?
  notes        String?              @db.Text
  active       Boolean              @default(true)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([userId])
  @@index([active])
}

// Care notes and updates
model Note {
  id        String   @id @default(cuid())
  familyId  String
  userId    String
  title     String?
  content   String   @db.Text
  category  String?  // health, care, observation, general
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([userId])
  @@index([createdAt])
  @@index([category])
}

// Important documents for care planning
enum DocumentCategory {
  MEDICAL
  LEGAL
  INSURANCE
  FINANCIAL
  OTHER
}

model Document {
  id          String           @id @default(cuid())
  familyId    String
  name        String
  category    DocumentCategory
  fileUrl     String?          // URL to uploaded file
  fileName    String?          // Original file name
  fileSize    Int?             // File size in bytes
  mimeType    String?          // File MIME type
  notes       String?          @db.Text
  uploadedBy  String?          // User who uploaded
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  family       Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  uploadedByUser User? @relation(fields: [uploadedBy], references: [id])

  @@index([familyId])
  @@index([category])
  @@index([createdAt])
}

// Care plan details
enum CareLevel {
  LOW
  MODERATE
  HIGH
  INTENSIVE
}

model CarePlan {
  id                String    @id @default(cuid())
  familyId          String    @unique
  careLevel         CareLevel @default(MODERATE)
  careLevelDescription String? @db.Text
  estimatedCostMin  Int?      // Minimum estimated monthly cost in dollars
  estimatedCostMax  Int?      // Maximum estimated monthly cost in dollars
  careNotes         String?   @db.Text
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
}

// Care scenarios for different situations
enum ScenarioType {
  MEDICAL_EMERGENCY
  HOSPITALIZATION
  INCREASED_CARE
  ASSISTED_LIVING
  END_OF_LIFE
}

model CareScenario {
  id          String       @id @default(cuid())
  familyId    String
  type        ScenarioType
  title       String
  icon        String?      // Emoji or icon
  content     String       @db.Text // JSON string with scenario details
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([type])
}

// Family member monthly contribution splits
model FamilyContribution {
  id          String   @id @default(cuid())
  familyId    String
  memberName  String   // Name of the family member contributing
  amount      Float    // Monthly contribution amount
  percentage  Int      // Percentage of total contributions (1-100)
  color       String   @default("#6366f1") // Color for UI display
  initial     String   @default("FM") // Initials for avatar
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
}

// Blog posts for public marketing site
enum BlogCategory {
  CAREGIVING_TIPS
  FAMILY_STORIES
  HEALTH_WELLNESS
  FINANCIAL_PLANNING
  TECHNOLOGY
  LEGAL_MATTERS
  COMPANY_NEWS
}

model BlogPost {
  id            String        @id @default(cuid())
  title         String
  slug          String        @unique
  excerpt       String        @db.Text
  content       String        @db.Text
  category      BlogCategory
  author        String        // Author name
  authorTitle   String?       // e.g., "Senior Care Specialist"
  coverImage    String?       // URL to cover image
  readTime      Int           @default(5) // Estimated read time in minutes
  published     Boolean       @default(false)
  publishedAt   DateTime?
  views         Int           @default(0)
  relatedPostIds Json?        // Array of related blog post IDs for cross-referencing
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([category])
  @@index([published])
  @@index([publishedAt])
  @@index([slug])
}
